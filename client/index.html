<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-signin-client_id" content="626140139553-2gqo2q2eq41qdb09uqpik8vrui87kqil.apps.googleusercontent.com">
  <title>To do App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">To Do Fancy App</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" id="nav-logout" href="#">Logout</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Features</a>
          </li>
        </ul>
      </div>
    </div>
  </nav><br><br>

  <!-- Login Form -->

  <form id="login-form">
    <div class="w-25 mb-3">
      <label for="exampleInputEmail1" class="form-label">Email address</label>
      <input type="email" class="form-control" id="emailInput" aria-describedby="emailHelp">

    </div>
    <div class="w-25 mb-3">
      <label for="exampleInputPassword1" class="form-label">Password</label>
      <input type="password" class="form-control" id="passwordInput">
    </div>

    <button type="submit" class="btn btn-primary">Submit</button><br><br>
    <div class="g-signin2" data-onsuccess="onSignIn"></div>

  </form><br><br><br>

  <!-- Add Todo -->
  <form id="add-form">
    <h5>Add Your next to do list</h5>
    <div class="w-25 mb-3">
      <label for="exampleInputEmail1" class="form-label">Activity Title</label>
      <input type="text" class="form-control">
    </div>
    <div class="w-25 mb-3">
      <label for="exampleInputEmail1" class="form-label">Activity Description</label>
      <input type="text" class="form-control">
    </div>
    <div class="w-25 mb-3">
      <label for="exampleInputEmail1" class="form-label">Due Date</label>
      <input type="date" class="form-control">
    </div>


    <button type="submit" class="btn btn-primary">Add</button>
  </form><br><br>



  <!-- To Do -->
  <div id="todo-list">
    <div class="w-25 card">
      <div class="card-header">
        Todo Title
      </div>
      <div class="card-body">
        <h5 class="card-title">Todo title </h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
        <a href="#" class="btn btn-primary">Edit</a>
        <a href="#" class="btn btn-primary">Delete</a>
      </div>
    </div>
    <div class="w-25 card">
      <div class="card-header">
        Todo Title
      </div>
      <div class="card-body">
        <h5 class="card-title">Todo title </h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
        <a href="#" class="btn btn-primary">Edit</a>
        <a href="#" class="btn btn-primary">Delete</a>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"
    integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU"
    crossorigin="anonymous"></script>

  <!-- JQUERY -->
  
  <script>
    const baseUrl = 'http://localhost:3000/'
    function onSignIn(googleUser) {
  var id_token = googleUser.getAuthResponse().id_token;
  console.log(id_token);

  $.ajax({
    url: baseUrl + 'users/googlelogin',
    method: 'POST',
    data:{
      googleToken: id_token
    }
  })
  .done((response) => {
    localStorage.setItem('access_token',response.access_token)
    auth()
    // console.log(response);
  })
  .fail((err)=>{
    console.log(err);
  })
}

    function auth() {
      if (!localStorage.getItem("access_token")) {
        $('#login-form').show()
        $('#add-form').hide()
        $('#todo-list').hide()
      } else {
        $('#login-form').hide()
        $('#add-form').show()
        $('#todo-list').show()
      }
      getToDos()
    }

    function login() {
      const email = $('#emailInput').val()
      const password = $('#passwordInput').val()
      $.ajax({
        url: baseUrl + 'users/login',
        method: 'POST',
        data: {
          email,
          password
        }
      })
        .done((response) => {
          console.log(response);
          localStorage.setItem('access_token', response.access_token)
          auth()
        })
        .fail((xhr, text) => {
          console.log(xhr, text);
        })
        .always(_=>{
          $('#login-form').trigger('reset')
          // console.log('always')
        })
    }
    function logout() {
      localStorage.clear()
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
    }

    function getToDos(){
      $.ajax({
        url: baseUrl + 'todos',
        method: 'GET',
        headers:{
        access_token: localStorage.getItem('access_token')
        }
      })
      .done((todo) => {
        $('#todo-list').empty()
          todo.forEach(value =>{
            $('#todo-list'),append(`
            <div class="w-25 card" id="todo-${value.id}">
              <div class="card-header">
                Todo Title
              </div>
              <div class="card-body">
                <h5 class="card-title">${value.title}</h5>
                <p class="card-text">${value.description}</p>
                <a href="#" class="btn btn-primary">Edit</a>
                <a href="#" class="btn btn-primary" onclick="destroy(${value.id})">Delete</a>
              </div>
            </div>
            `)
          });
          
        })
        .fail((xhr, text) => {
          console.log(xhr, text);
        })
    }

    function destroy(id){
      $.ajax({
        url: baseUrl + 'todos/' + id,
        method: 'DELETE',
        headers:{
        access_token: localStorage.getItem('access_token')
        }
      })
      .done((_)=>{
        getToDos()
      })
      .fail((err, text) => {
          console.log(err, text);
        })
    }

    $(document).ready(() => {
      auth()
      $('#login-form').on('submit', (e) =>{
        e.preventDefault()
        login()
      })
    })

  </script>
</body>

</html>